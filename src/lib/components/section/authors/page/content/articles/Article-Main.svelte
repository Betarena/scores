<!--
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ“Œ High Order Component Overview                                                 â”‚
â”£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”«
â”‚ â¤ Internal Svelte Code Format |:| V.8.0                                          â”‚
â”‚ â¤ Status |:| ğŸ”’ LOCKED                                                           â”‚
â”‚ â¤ Author(s) |:| @migbash                                                         â”‚
â”£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”«
â”‚ ğŸ“ Description                                                                   â”‚
â”£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”«
â”‚ Betarena (Component) || Authors Content Main                                     â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
-->

<!--
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸŸ¦ Svelte Component JS/TS                                                        â”‚
â”£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”«
â”‚ â¤ HINT: â”‚ Access snippets for '<script> [..] </script>' those found in           â”‚
â”‚         â”‚ '.vscode/snippets.code-snippets' via intellisense using 'doc'          â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
-->

<script lang="ts">

  // #region â¤ ğŸ“¦ Package Imports

  // â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  // â”‚ NOTE:                                                                  â”‚
  // â”‚ Please add inside 'this' region the 'imports' that are required        â”‚
  // â”‚ by 'this' .svelte file is ran.                                         â”‚
  // â”‚ IMPORTANT                                                              â”‚
  // â”‚ Please, structure the imports as follows:                              â”‚
  // â”‚ 1. svelte/sveltekit imports                                            â”‚
  // â”‚ 2. project-internal files and logic                                    â”‚
  // â”‚ 3. component import(s)                                                 â”‚
  // â”‚ 4. assets import(s)                                                    â”‚
  // â”‚ 5. type(s) imports(s)                                                  â”‚
  // â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

  import { browser } from '$app/environment';
  import { page } from '$app/stores';

  import { get } from '$lib/api/utils.js';
  import sessionStore from '$lib/store/session.js';
  import userBetarenaSettings from '$lib/store/user-settings.js';
  import { dlogv2 } from '$lib/utils/debug.js';
  import { viewportChangeV2 } from '$lib/utils/device.js';

  import Button from '$lib/components/ui/Button.svelte';
  import Tabbar from '$lib/components/ui/Tabbar.svelte';
  import ArticleCard from '../../../common_ui/articles/Article-Card.svelte';
  import ArticleLoader from './Article-Loader.svelte';

  import type {
    IPageAuthorArticleData,
    IPageAuthorAuthorData,
    IPageAuthorTagData,
    IPageAuthorTagDataFinal
  } from '@betarena/scores-lib/types/v8/preload.authors.js';
  import type { IPageAuthorTranslationDataFinal } from '@betarena/scores-lib/types/v8/segment.authors.tags.js';
  import { prepareArticlesMap, type IArticle, type ITagsWidgetData } from '../../helpers.js';

  // #endregion â¤ ğŸ“¦ Package Imports

  // #region â¤ ğŸ“Œ VARIABLES

  // â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  // â”‚ NOTE:                                                                  â”‚
  // â”‚ Please add inside 'this' region the 'variables' that are to be         â”‚
  // â”‚ and are expected to be used by 'this' .svelte file / component.        â”‚
  // â”‚ IMPORTANT                                                              â”‚
  // â”‚ Please, structure the imports as follows:                              â”‚
  // â”‚ 1. export const / let [..]                                             â”‚
  // â”‚ 2. const [..]                                                          â”‚
  // â”‚ 3. let [..]                                                            â”‚
  // â”‚ 4. $: [..]                                                             â”‚
  // â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

  const
    /**
     * @description
     *  ğŸ“ `this` component **main** `id` and `data-testid` prefix.
     */ // eslint-disable-next-line no-unused-vars
    CNAME: string = 'content',
    /**
     * @description
     *  ğŸ“ threshold start + state for ğŸ“± MOBILE
     */ // eslint-disable-next-line no-unused-vars
    VIEWPORT_MOBILE_INIT: [number, boolean] = [575, true],
    /**
     * @description
     *  ğŸ“ threshold start + state for ğŸ’» TABLET
     */ // eslint-disable-next-line no-unused-vars
    VIEWPORT_TABLET_INIT: [number, boolean] = [1160, true]
  ;

  $: ({ windowWidth, globalState } = $sessionStore);
  $: isPWA = globalState.has('IsPWA');
  $: [mobile, tablet]
    = viewportChangeV2
    (
      windowWidth,
      VIEWPORT_MOBILE_INIT[0],
      VIEWPORT_TABLET_INIT[0]
    )
  ;

  $: widgetData = $page.data as IPageAuthorTagDataFinal & {
    translations: IPageAuthorTranslationDataFinal;
  } | undefined;
  $: pageSeo = $page.data.seoTamplate;
  $: translations = widgetData?.translations;

  /**
   * @description
   * ğŸ“ Interecpted data for `map` instance of `author(s)`.
   */
  $: mapAuthors = new Map(widgetData?.mapAuthor ?? []);
  /**
   * @description
   * ğŸ“ Interecpted data for `map` instance of `tag(s)`.
   */
  $: mapTags = new Map(widgetData?.mapTag ?? []);
  /**
   * @description
   * ğŸ“ Interecpted data for `map` instance of `article(s)`.
   */
  $: mapArticles = new Map(widgetData?.mapArticle ?? []);
  /**
   * @description
   * ğŸ“ Currently selected tag data.
   */
  $: selectedTag = mapTags.get(widgetData?.tagId ?? 0);
  /**
   * @description
   * ğŸ“ Categories avaialble.
   */
  $: categories = selectedTag != undefined ? [selectedTag] : [];

  $: if (browser) updateData(widgetData ?? {} as ITagsWidgetData, true);

  let
    /**
     * @description
     * ğŸ“ `Map` where, `key=tagId` and `value=tagData`.
     */
    mapTagSelectData
      = new Map
        <
          number,
          ITagsWidgetData &
          {
            mapArticlesMod: Map < number, IArticle >;
            currentPage: number
          }
        >(),
    /**
     * @description
     * ğŸ“ State UI for `Loading Articles`.
     */
    isLoadingArticles = true,
    /**
     * @description
     * ğŸ“ `Map` data for `article(s)`, ready for frontend consumption.
     */
    mapArticlesMod =  new Map < number, IArticle >(),
  ;

  // #endregion â¤ ğŸ“Œ VARIABLES

  // #region â¤ ğŸ› ï¸ METHODS

  // â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  // â”‚ NOTE:                                                                  â”‚
  // â”‚ Please add inside 'this' region the 'methods' that are to be           â”‚
  // â”‚ and are expected to be used by 'this' .svelte file / component.        â”‚
  // â”‚ IMPORTANT                                                              â”‚
  // â”‚ Please, structure the imports as follows:                              â”‚
  // â”‚ 1. function (..)                                                       â”‚
  // â”‚ 2. async function (..)                                                 â”‚
  // â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

  /**
   * @author
   *  <-insert-author->
   * @summary
   *  ğŸŸ¦ HELPER
   * @description
   *  ğŸ“ Selects `tag`.
   * @param { CustomEvent<IPageAuthorTagData> } e
   *  ğŸ’  **REQUIRED** Event argument.
   * @returns { void }
   */
  function selectTag
  (
    e: CustomEvent<IPageAuthorTagData>
  ): void
  {
    // [ğŸ]
    dlogv2
    (
      'selectTag(..)',
      [
        `ğŸ”¹ [var] â¤ e :|: ${e}`,
      ],
      true
    );

    selectedTag = e.detail;
    mapArticlesMod = new Map();

    if (!mapTagSelectData.has(selectedTag.id ?? 0))
      loadTagArticles();
    else
      mapArticlesMod = mapTagSelectData.get(selectedTag.id ?? 0)?.mapArticlesMod ?? new Map();
    ;

    return;
  }

  /**
   * @author
   *  <-insert-author->
   * @summary
   *  ğŸŸ¦ HELPER
   * @description
   *  ğŸ“ Update data for 'content' page.
   * @param { ITagsWidgetData } dataNew
   *  ğŸ’  **REQUIRED** New data instance.
   * @returns { void }
   */
  function updateData
  (
    dataNew: ITagsWidgetData,
    reset: boolean = false
  ): void
  {
    // [ğŸ]
    dlogv2
    (
      'updateData(..) // START',
      [
        `ğŸ”¹ [var] â¤ dataNew :|: ${dataNew}`,
      ],
      true
    );

    if (reset)
    {
      mapArticles = new Map();
      mapAuthors = new Map();
      mapTags = new Map();
      mapTagSelectData = new Map();
      mapArticlesMod = new Map();
    }

    mapArticles = new Map([...mapArticles, ...dataNew.mapArticle]);
    mapAuthors = new Map([...mapAuthors, ...dataNew.mapAuthor]);
    mapTags = new Map([...mapTags, ...dataNew.mapTag]);

    const
      /**
       * @description
       * ğŸ“ `Map` article generated from NEW data.
       */
      mapNewArticlesMod
        = prepareArticlesMap
        (
          new Map(dataNew.mapArticle),
          new Map(dataNew.mapTag),
          new Map(dataNew.mapAuthor),
        )
    ;

    mapArticlesMod = new Map([...mapArticlesMod, ...mapNewArticlesMod]);

    if (!mapTagSelectData.has(dataNew.tagId))
      mapTagSelectData.set
      (
        dataNew.tagId,
        {
          ...dataNew,
          mapArticlesMod,
          currentPage: 0,
          totalArticlesCount: dataNew.totalArticlesCount,
        }
      );
    ;

    isLoadingArticles = false;

    // [ğŸ]
    dlogv2
    (
      'updateData(..) // END',
      [ ],
      true
    );

    return;
  }

  /**
   * @author
   *  <-insert-author->
   * @summary
   *  ğŸŸ¦ HELPER
   * @description
   *  ğŸ“ Custom handler for scroll logic.
   * @return { void }
   */
  function scrollHandler
  (
  ): void
  {
    if (!isPWA && (mobile || tablet)) return;

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 5)
      loadMore();
    ;

    return;
  }

  /**
   * @author
   *  <-insert-author->
   * @summary
   *  ğŸŸ¦ HELPER
   * @description
   *  ğŸ“ Check for instance of loading more articles.
   * @return { Promise < void > }
   */
  async function loadMore
  (
  ): Promise < void >
  {
    // [ğŸ]
    dlogv2
    (
      'loadMore(..)',
      [ ],
      true
    );

    const
      /**
       * @description
       * ğŸ“ Selected 'tag' tab data.
       */
      dataTag = mapTagSelectData.get(selectedTag?.id ?? 0),
      /**
       * @description
       * ğŸ“ Article length.
       */
      length = dataTag?.mapArticlesMod.size || 0
    ;

    if (!selectedTag || !dataTag || length === dataTag.totalArticlesCount) return;

    loadTagArticles
    (
      dataTag.currentPage + 1
    );

    return;
  }

  /**
   * @author
   *  <-insert-author->
   * @summary
   *  ğŸŸ¦ HELPER
   * @description
   *  ğŸ“ Load tag articles.
   * @param { number } [page=0]
   *  ğŸ’  **REQUIRED** Number page to request.
   * @return { Promise < void > }
   */
  async function loadTagArticles
  (
    page: number = 0
  ): Promise < void >
  {
    // [ğŸ]
    dlogv2
    (
      'loadTagArticles(..) // START',
      [
        `ğŸ”¹ [var] â¤ page |:| ${page}`,
      ],
      true
    );

    const
      /**
       * @description
       * ğŸ“ Following tags.
       */
      followingTags = $userBetarenaSettings.user?.scores_user_data?.following?.tags
    ;

    let
      /**
       * @description
       * ğŸ“ URL to be requested.
       */
      url = `/api/data/author/content?&lang=${$sessionStore.serverLang}&page=${page}`
    ;

    if (followingTags?.length)
      url += `&followingTags=${followingTags.join(',')}`;
    ;

    isLoadingArticles = true;

    const
      /**
       * @description
       * ğŸ“ Data Response (0).
       */
      dataRes0
        = await get
        (
          url
        ) as ITagsWidgetData
    ;

    updateData(dataRes0);

    // [ğŸ]
    dlogv2
    (
      'loadTagArticles(..) // END',
      [
        `ğŸ”¹ [var] â¤ page |:| ${page}`,
      ],
      true
    );

    if (!dataRes0) return;

    mapTagSelectData.set
    (
      selectedTag.id!,
      {
        ...dataRes0,
        mapArticlesMod,
        currentPage: page,
      }
    );

    return;
  }

  // #endregion â¤ ğŸ› ï¸ METHODS

</script>

<!--
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ’  Svelte Component HTML                                                         â”‚
â”£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”«
â”‚ â¤ HINT: â”‚ Use 'Ctrl + Space' to autocomplete global class=styles, dynamically    â”‚
â”‚         â”‚ imported from './static/app.css'                                       â”‚
â”‚ â¤ HINT: â”‚ access custom Betarena Scores VScode Snippets by typing emmet-like     â”‚
â”‚         â”‚ abbrev.                                                                â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
-->

<svelte:window on:scroll={scrollHandler} />

<!--
â•­â”€â”€â”€â”€â”€
â”‚ > INSERT-DESCRIPTION
â•°â”€â”€â”€â”€â”€
-->
<div
  class="tabbar-wrapper"
>
  {#if categories.length}
    <Tabbar
      on:select={selectTag}
      data={categories}
      selected={selectedTag}
      height={mobile ? 14 : 8}
      let:tab
    >
    {tab.name}
  </Tabbar>
  {/if}
</div>

<!--
â•­â”€â”€â”€â”€â”€
â”‚ > INSERT-DESCRIPTION
â•°â”€â”€â”€â”€â”€
-->
<div
  class="content"
>
  <div
    class="listArticlesMod"
  >
    {#each [...mapArticlesMod.entries()] as [id,article] (id)}
      <ArticleCard
        {mobile}
        {article}
        {tablet}
        {translations}
      />
    {/each}

    {#if isLoadingArticles}
      {#each Array(10) as _item}
        <ArticleLoader
          {mobile}
          {tablet}
        />
      {/each}
    {/if}
  </div>

  {#if (tablet || mobile) && !isPWA && mapArticlesMod.size}
    <div class="load-more">
      <Button type="outline" on:click={loadMore}>Load More</Button>
    </div>
  {/if}
</div>
